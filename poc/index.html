<html>

<head>

<style>
canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    background-color: rgba(0,0,0,1);
}
</style>

<script src="../lib/global.js"></script>
<script src="../lib/debug.js"></script>
<script src="../lib/mouse.js"></script>
<script src="../lib/image.js"></script>
<script src="../lib/glUtil.js"></script>
<script src="main.js"></script>

<!-- ****************************************************************************************** -->
<script id="VertexShader" type="Vertex-Shader">
attribute vec2 inPosition;      // input qualifier for vertex shader , different for each invocation
attribute vec2 inScreenVertex;  // input qualifier for vertex shader , of program stage
varying vec2 texCoord;          // output qualifier for vertex shader

uniform vec2 uScreen;           // remains "uniform" per rendering call
varying vec2 screen;            // output qualifier for vertex shader

void main() {
    screen = uScreen;
    //vec2 mapping = (2.0 * inPosition / screen - 1.0) * vec2(1, -1);
    vec2 mapping = (2.0 * inPosition / screen - 1.0) * vec2(1, -1);
    gl_Position = vec4(mapping, 0, 1);
    texCoord = inScreenVertex;
    //outColor = vec4(inPosition, 0,1);
}
</script>

<!-- ****************************************************************************************** -->
<script id="FragmentShader" type="Fragment-Shader">
precision mediump float;
uniform sampler2D clear;
uniform sampler2D atlas;
uniform sampler2D edit;

varying vec2 texCoord;     // output qualifier for vertex shader , texCoords from vertex shader
varying vec2 screen;

uniform vec2 uMouse;     // remains "uniform" per rendering call
uniform vec2 uCamera;     // remains "uniform" per rendering call
uniform float uTile[10];
uniform float uIsFirst;

uniform vec2 atlasWLLocation;
uniform vec2 clearWLLocation;
uniform vec2 editWLLocation;

void main() {

    float tileValue = 12.0;

    vec4 clearColor = texture2D( clear, texCoord);
    vec4 editColor = texture2D( edit, texCoord);
    //vec4 atlasColor = texture2D( atlas, texCoord);

    float xScale, yScale, zoom, xZoom, yZoom;
    zoom = 1.0;
    xZoom = zoom;
    yZoom = zoom;
    xScale = xZoom * screen.x / atlasWLLocation.x;
    yScale = yZoom * screen.y / atlasWLLocation.y;
    vec2 atlasCoordTransform = vec2(texCoord.x*xScale,texCoord.y*yScale);
    vec4 atlasColor = texture2D( atlas, atlasCoordTransform);


    //gl_FragColor = texClear;
    //gl_FragColor = texAtlas;

    // if (clearColor != vec4(0,0,0,0)) {
    //     color = clearColor;
    // } else if (atlasColor != vec4(0,0,0,0)) {
    //     color = atlasColor;
    // } else if (editColor != vec4(0,0,0,0)) {
    //     color = editColor;
    // } else {
    //     color = vec4(1,0,1,0.75);
    // }

        // color =  atlasColor + clearColor + editColor ;

// if (clearColor == vec4(0,0,0,0)) color = vec4(1,1,1,1);

// if (atlasColor != vec4(0,0,0,0)) {
//     color = atlasColor;
// } else if (editColor != vec4(0,0,0,0)) {
//     color = editColor;
// } else {
//     color = vec4(0,0,0,0);
// }

    vec4 color;

    // alpha (0 = fully transparent ,  1 = fully opaque)
    // if any hint of transparency then treat it fully transparent
    // pixels are either fully transparent or fully opaque
    // this fixes atlas ghost weirdness ...

    // if (clearColor.w < 1.0) clearColor = vec4(0,0,0,0);
    // if (editColor.w < 1.0) editColor = vec4(0,0,0,0);
    // if (atlasColor.w < 1.0) atlasColor = vec4(0,0,0,0);


    // if (false){ // temporary for debugging , keep everything as else if

    // } else if (editColor.xyz != vec3(0,0,0)) {
    //     color = editColor;
    // } else if (atlasColor.xyz != vec3(0,0,0)) {
    //     color = atlasColor;
    // } else if (clearColor.xyz != vec3(0,0,0)) {
    //     color = clearColor;

    // } else {
    //     color = vec4(0.2,0.2,0.2,1);        
    // }

    gl_FragColor =  editColor + atlasColor + clearColor;

//    gl_FragColor =  atlasColor;

}
</script>

<!-- ****************************************************************************************** -->
</head>

<body>
<canvas id="glCanvas"></canvas>
</body>

</html>
